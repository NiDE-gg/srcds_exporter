machine:
  environment:
    PATH: "/usr/local/go/bin:/usr/local/go_workspace/bin:~/.go_workspace/bin:${PATH}"
    GOPATH: "${HOME}/.go_workspace:/usr/local/go_workspace"
    VERSION: "1.0.0"

dependencies:
  override:
    - mkdir -p ${HOME}/.go_workspace/src/github.com/${CIRCLE_PROJECT_USERNAME} ${HOME}/output
    - ln -sf ${HOME}/${CIRCLE_PROJECT_REPONAME} ${HOME}/.go_workspace/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    - go get github.com/mitchellh/gox
    - go get github.com/tcnksm/ghr
    - >
        gox -output="${HOME}/output/srcds_exporter_{{.OS}}_{{.Arch}}" -verbose -ldflags '-X {{repoPath}}/vendor/github.com/prometheus/common/version.Version='"${VERSION}"' -X {{repoPath}}/vendor/github.com/prometheus/common/version.Revision='"${CIRCLE_SHA1}"' -X {{repoPath}}/vendor/github.com/prometheus/common/version.Branch='"${CIRCLE_BRANCH}"' -X {{repoPath}}/vendor/github.com/prometheus/common/version.BuildUser='"${USER}@${HOSTNAME}"' -X {{repoPath}}/vendor/github.com/prometheus/common/version.BuildDate='"$(date +%Y%m%d-%H:%M:%S)"'' "github.com/galexrt/srcds_exporter"
    - ghr -draft -replace -u "${CIRCLE_PROJECT_USERNAME}" -r "${CIRCLE_PROJECT_REPONAME}" "${CIRCLE_BRANCH}-build" "${HOME}/output"

test:
  override:
    - go test -v -race github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/...

deployment:
  release:
    tag: /release\/[0-9]+(\.[0-9]+)*/
    owner: galexrt
    commands:
      - ghr -replace -u "${CIRCLE_PROJECT_USERNAME}" -r "${CIRCLE_PROJECT_REPONAME}" "${CIRCLE_TAG}" "${HOME}/output"
